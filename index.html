<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Realtime Status Map</title>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
body{margin:0;}

#app{
  width:100vw;
  height:100dvh;
  position:relative;
}

#app:fullscreen{
  background:#fff;
}

#map{
  width:100%;
  height:100%;
  position:relative;
}


/* ===== MARKER BASE ===== */
/* ----- Status ----- */
.marker{
  border-radius:50%;
  transition:opacity .2s, box-shadow .2s, border .2s;
  box-sizing:border-box;
  cursor: default;   /* ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô = ‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ */
}
.marker:not(.gray){
  cursor:pointer;   /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏°‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÑ‡∏î‡πâ */
}
.marker:not(.gray):hover{
  background:black !important;  /* ‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥ ‡πÄ‡∏ß‡∏•‡∏≤ hover */ 
}

/* ----- WRL ----- */
.wrl-marker{
  cursor:pointer;  /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏°‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡∏á WRL*/
}
.wrl-marker:hover{
  background:black !important;  /* ‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥ ‡πÄ‡∏ß‡∏•‡∏≤ hover */ 
}

/* ===== FILTERED ===== */
.gray{
  background:#ccc!important;
  opacity:.35;
  animation:none!important;
  box-shadow:none!important;
  border:none!important;
}

/* ===== BLINK ===== */
.force-blink{animation:blink 1s infinite!important;}

/* ===== STATUS COLOR ===== */
.offline{width:8.5px;height:8.5px;background:#FF0000;}
.connecting{width:8.5px;height:8.5px;background:#FF9900;}
.telemetry{width:8.5px;height:8.5px;background:#FFFF00;}
.initializing{width:8.5px;height:8.5px;background:#00FF00;}
.online{width:8.5px;height:8.5px;background:#009900;}
.none{width:8.5px;height:8.5px;background:#F6F6F6;}

/* ===== BLINK BORDER ===== */
.force-blink.offline{border:1.5px solid #CC0000;box-shadow:0 0 6px rgba(255,0,0,.7);}
.force-blink.connecting{border:1.5px solid #CC7A00;box-shadow:0 0 6px rgba(255,153,0,.7);}
.force-blink.telemetry{border:1.5px solid #B3B300;box-shadow:0 0 6px rgba(255,255,0,.7);}
.force-blink.initializing{border:1.5px solid #009900;box-shadow:0 0 6px rgba(0,255,0,.7);}
.force-blink.online{border:1.5px solid #1B5E20;box-shadow:0 0 6px rgba(46,125,50,.7);}
.force-blink.none{border:1.5px solid #4D4D4D;box-shadow:0 0 6px rgba(0,0,0,.7);}

@keyframes blink{
  0%{opacity:1}
  50%{opacity:.2}
  100%{opacity:1}
}

/* ===== WRL BLINK ===== */
.wrl-blink{
  animation:blink 0.5s infinite;
  box-shadow:0 0 6px rgba(255,0,0,.8);
}

/* ===== PANEL GROUP (VERTICAL STACK) ===== */
.panel-group{
  position:absolute;
  left:10px;
  top:10px;
  display:flex;
  flex-direction:column;
  gap:30px;
  z-index:999;
}

/* ===== SEARCH GROUP ===== */
.search-group{
  width:auto;
}

/* ===== PANEL WRAP (STATUS / DEVICE / ACK) ===== */
.panel-wrap{
  display:grid;
  grid-template-columns:max-content;
  gap:0px; 
}

/* ===== PANEL BOX ===== */
.panel-box{}
.status-box{margin-bottom:10px;}
.device-box{margin-bottom:10px;}
.ack-box{margin-bottom:0;}

/* ===== PANEL ===== */
.panel{
  background:rgba(255,255,255,.95);
  padding:10px 14px;
  border-radius:8px;
  font-family:sans-serif;
  font-size:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
  min-width:120px;
}

/* ===== ROW ===== */
.row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:6px;
  cursor:pointer;
}
.row:last-child{margin-bottom:0;}
.active{font-weight:bold;}

/* ===== RESET ===== */
.reset{
  color:#1a73e8;
  font-weight:bold;
}

/* ===== DOT ===== */
.dot{
  width:10px;height:10px;border-radius:50%;box-sizing:border-box;
  transition: transform .15s ease, box-shadow .15s ease;
}
.dot.force-blink{
  transform: scale(1.25);
}
.dot-offline{background:#FF0000;border:1px solid #CC0000;}
.dot-connecting{background:#FF9900;border:1px solid #CC7A00;}
.dot-telemetry{background:#FFFF00;border:1px solid #B3B300;}
.dot-initializing{background:#00FF00;border:1px solid #009900;}
.dot-online{background:#009900;border:1px solid #1B5E20;}
.dot-none{background:#F6F6F6;border:1px solid #4D4D4D;}

.force-blink.dot-offline{border:1.5px solid #CC0000;box-shadow:0 0 6px rgba(255,0,0,.9);}
.force-blink.dot-connecting{border:1.5px solid #CC7A00;box-shadow:0 0 6px rgba(255,153,0,.9);}
.force-blink.dot-telemetry{border:1.5px solid #B3B300;box-shadow:0 0 6px rgba(255,255,0,.9);}
.force-blink.dot-initializing{border:1.5px solid #009900;box-shadow:0 0 6px rgba(0,255,0,.9);}
.force-blink.dot-online{border:1.5px solid #1B5E20;box-shadow:0 0 6px rgba(46,125,50,.9);}
.force-blink.dot-none{border:1.5px solid #4D4D4D;box-shadow:0 0 6px rgba(0,0,0,.9);}

/* ===== POPUP Z ===== */
.mapboxgl-popup{z-index:15!important;}

/* ===== RESET BUTTON (PRIMARY ACTION) ===== */
.reset-btn{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:4px 8px;
  border-radius:6px;
  background:#1a73e8;
  color:white;
  font-weight:bold;
  cursor:pointer;
  transition:.2s;
}

.reset-btn:hover{
  background:#1558b0;
  box-shadow:0 2px 6px rgba(26,115,232,.4);
}

/* ===== SEARCH SIZE + STYLE (Override Reset) ===== */
.search-large{
  padding:6px 10px;      
  border-radius:4px;     
  font-weight: normal;   
  border: none;          
}

/* ===== CLEAR SEARCH BUTTON ===== */
#clearSearchBtn{
  margin-left:auto;
  padding:2px 8px;        
  border:none;
  border-radius:6px;
  background:#1a73e8;
  color:white;
  cursor:pointer;
  transition: all 0.2s ease;
}

#clearSearchBtn:hover{
  background:#1558b0;     
  box-shadow:0 2px 6px rgba(26,115,232,.4);
}

/* ========================= */
/*    WRL Toggle Button      */
/* ========================= */

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏° */
.map-control {
  position: absolute;   /* ‡∏•‡∏≠‡∏¢ */
  top: 15px;            /* ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô */
  right: 15px;          /* ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏ß‡∏≤ */
  z-index: 1000;        /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ panel ‡∏≠‡∏∑‡πà‡∏ô */
}

/* ‡∏õ‡∏∏‡πà‡∏° */
#btnWRL {
  padding: 6px 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: white;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transition: all 0.2s ease;
}

/* ========
   ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ON
======== */
#btnWRL:not(.off){
  color: #9900FF;
}

/* Hover ‡∏ï‡∏≠‡∏ô ON ‚Üí preview ‡πÄ‡∏õ‡πá‡∏ô OFF */
#btnWRL:not(.off):hover{
  background: #e0e0e0;
  color: #666;
}

/* ========
   ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ OFF
======== */
#btnWRL.off {
  background: #e0e0e0;
  color: #666;
}

/* Hover ‡∏ï‡∏≠‡∏ô OFF ‚Üí preview ‡πÄ‡∏õ‡πá‡∏ô ON */
#btnWRL.off:hover{
  background: white;
  color: #9900FF;
}
/* ========================= */

/* ===== LATEST UPDATE BOX ===== */
#latestUpdateBox{
  position:absolute;
  left:12px;
  bottom:12px;
  background:rgba(255,255,255,.95);
  padding:6px 10px;
  border-radius:6px;
  font-family:sans-serif;
  font-size:13px;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
  z-index:999;
}

</style>
</head>

<body>

<div id="app">

<!--  ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏à‡∏∞‡πÉ‡∏´‡πâ WRL : ON ‡∏´‡∏£‡∏∑‡∏≠ OFF -->  
<div class="map-control">
  <button id="btnWRL" class="off" style="display:none">WRL : OFF</button>  
</div>


<div id="map"></div>

<!-- ===== LATEST UPDATE (Bottom Left) ===== -->
<div id="latestUpdateBox">
  Update : <span id="latestUpdateText">-</span>
</div>

<!-- ===== PANEL GROUP (VERTICAL) ===== -->
<div class="panel-group">

  <!-- ===== SEARCH GROUP ===== -->
  <div class="search-group">

    <div class="panel-box">
      <div class="panel" style="display:flex;gap:6px;">
        <input id="searchInput" type="search"
          placeholder="üîç Search anything..."
          style="width:160px;padding:6px;border:1px solid #ccc;border-radius:4px;">
        <button id="searchBtn" class="reset-btn search-large">
          Search
        </button>
      </div>
    </div>

    <div id="searchIndicator" class="panel-box" style="display:none;margin-top:6px;">
      <div class="panel"
        style="background:#e8f0fe;color:#1a73e8;
               display:flex;align-items:center;gap:8px;">
        <span>
          üîç Search Mode :
          <b><span id="searchCount">0</span></b> result(s)
        </span>

        <button id="clearSearchBtn" title="Clear Search">
          ‚úï
        </button>
      </div>
    </div>

  </div>

  <div class="panel-wrap">

    <!-- STATUS -->
    <div class="panel-box status-box">
      <div id="counter" class="panel">
        <div class="row" data-status="TOTAL">
          <span class="reset-btn" title="Clear Status / Device / Ack / Search">
            ‚ü≥ Reset
          </span>
          Total: <span id="c_total">0</span>
        </div>
        <hr>
        <div class="row" data-status="Offline"><span class="dot dot-offline"></span>Offline /Offscan: <span id="c_offline">0</span></div>
        <div class="row" data-status="Connecting"><span class="dot dot-connecting"></span>Connecting: <span id="c_connecting">0</span></div>
        <div class="row" data-status="Telemetry Failure"><span class="dot dot-telemetry"></span>Telemetry: <span id="c_telemetry">0</span></div>
        <div class="row" data-status="Initializing"><span class="dot dot-initializing"></span>Initializing: <span id="c_initializing">0</span></div>
        <div class="row" data-status="Online"><span class="dot dot-online"></span>Online: <span id="c_online">0</span></div>
        <div class="row" data-status="none"><span class="dot dot-none"></span>none: <span id="c_none">0</span></div>
      </div>
    </div>

    <!-- DEVICE -->
    <div class="panel-box device-box">
      <div id="device-filter" class="panel">
        <div class="row" data-device="ALL">Device ALL: <span id="d_all">0</span></div>
        <hr>
        <div class="row" data-device="DAU">DAU: <span id="d_dau">0</span></div>
        <div class="row" data-device="ROUTER">ROUTER: <span id="d_router">0</span></div>
        <div class="row" data-device="none">none: <span id="d_none">0</span></div>
      </div>
    </div>

    <!-- ACK -->
    <div class="panel-box ack-box">
      <div id="ack-filter" class="panel">
        <div class="row" data-ack="ALL">Acknowledge: <span id="a_all">0</span></div>
        <hr>
        <div class="row" data-ack="Yes">Yes: <span id="a_yes">0</span></div>
        <div class="row" data-ack="No">No: <span id="a_no">0</span></div>
        <div class="row" data-ack="none">none: <span id="a_none">0</span></div>
      </div>
    </div>

  </div>
</div>

<script>
mapboxgl.accessToken='pk.eyJ1IjoicHJhc2VydC1tYXBib3giLCJhIjoiY21rczRzanpqMTVrNDNlcHA3cndudHY2NCJ9.tE7h5N64QMt2FczrH06uCA';
//const API_URL='https://script.google.com/macros/s/AKfycbyir64PbHBtTUzileqK0TXE9eu3ib5olFfAT32p24tAnwVjCb9NThC0gBXMFYZ2yn6Y/exec';

// --- ‡∏•‡πá‡∏≠‡∏Å API ---
const API_KEY="CHANGE_ME_TO_LONG_RANDOM_STRING";
const APP_NAME="REALTIME-MAP";
const API_BASE='https://script.google.com/macros/s/AKfycbyir64PbHBtTUzileqK0TXE9eu3ib5olFfAT32p24tAnwVjCb9NThC0gBXMFYZ2yn6Y/exec';

const API_URL = `${API_BASE}?key=${encodeURIComponent(API_KEY)}&app=${encodeURIComponent(APP_NAME)}`;
const API_WRL = `${API_URL}&layer=wrl`;
// --------------

const VALID_STATUS=new Set(["Online","Connecting","Initializing","Offline","Telemetry Failure"]);
const VALID_DEVICE=new Set(["DAU","ROUTER"]);
const VALID_ACK=new Set(["Yes","No"]);

// normalize status ‡∏î‡πâ‡∏ß‡∏¢ word boundary, ‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà 
const NORMALIZE_STATUS = [...VALID_STATUS].map(s => ({
  key: s,
  regex: new RegExp(
    `\\b${s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`,
    "i"
  )
}));

const map=new mapboxgl.Map({
  container:'map',
  style:'mapbox://styles/mapbox/streets-v12',
  center:[100.5,17.5],
  zoom:6
});

//------------------------------------
//       ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Full screen ‡πÑ‡∏î‡πâ
//------------------------------------
//‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Full screen
map.addControl(
  new mapboxgl.FullscreenControl({
    container: document.getElementById('app')
  }),
  'bottom-right'
);

//‡∏Å‡∏±‡∏ô map ‡πÄ‡∏û‡∏∑‡πâ‡∏¢‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Fullscreen / ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Fullscreen
document.addEventListener('fullscreenchange', () => {
  map.resize();
});

//‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏à‡∏≠‡πÉ‡∏ô iPad, iPhone, Android tablet 
window.addEventListener('orientationchange', () => {
  setTimeout(() => {
    map.resize();
  }, 300);  
});
//------------------------------------

const markers=[];
const wrlMarkers = new Map();

let wrlVisible = false;  //‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏à‡∏∞‡πÉ‡∏´‡πâ WRL : ON ‡∏´‡∏£‡∏∑‡∏≠ OFF
let lastUpdateStamp=null;  //‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Timestamp ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥ Advanced Delta Refresh
let latestWRLData = [];  //‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö WRL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
let currentPopup = null;  //‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° popup

let bounds=new mapboxgl.LngLatBounds();
let activeStatuses=new Set(),activeDevice=null,activeAck=null;

// ‚òÖ ADD
let searchResultSet=null;

// -start- ‚òÖ ADD : popup permission state (allow popup only when Marker label is visible)
let searchActive=false;
let filterActive=false;
// -end-

// zIndex priority (higher = more important)
const Z_INDEX = {selected: 1000, wrl_false: 110, wrl_true: 100, hidden: 1};
const zBase={Offline:60,Connecting:70,"Telemetry Failure":50,Initializing:40,Online:10,none:30,_default:20};

async function loadWRL(){
  try{
    const response = await fetch(API_WRL);
    const r = await response.json();

    if(!r || !r.success || !Array.isArray(r.data)){
      console.warn("WRL load failed");
      return;
    }

    //‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• WRL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ
    latestWRLData = r.data;

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô marker ‡∏ã‡πâ‡∏≠‡∏ô
    wrlMarkers.forEach(m=>m.remove());
    wrlMarkers.clear();

    r.data.forEach(p=>{

      // ‡∏ï‡∏£‡∏ß‡∏à lat/lng ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
      const lat = Number(p.lat);
      const lng = Number(p.lng);
      if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;

      const el = document.createElement('div');
      el.className = "wrl-marker";
      el.style.width = "6.5px";
      el.style.height = "6.5px";
      el.style.borderRadius = "50%";  //"50%" >> ‡∏ß‡∏á‡∏Å‡∏•‡∏°

      const isFalse = String(p.status).toLowerCase() === "false";
      el.dataset.status = String(!isFalse);

      // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≠‡∏á WRL ‡πÅ‡∏¢‡∏Å‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á  false ‡∏´‡∏£‡∏∑‡∏≠ true
      if (isFalse) {
        el.style.backgroundColor = "rgba(153,0,255,0.45)";   // false ‡πÄ‡∏Ç‡πâ‡∏°
        el.style.border = "2.0px solid #ff0000";
        el.style.zIndex = Z_INDEX.wrl_false;
        el.classList.add("wrl-blink");                       // ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ false
      } else {
        el.style.backgroundColor = "rgba(153,0,255,0.15)";   // true ‡πÄ‡∏î‡∏¥‡∏°
        el.style.border = "1.5px solid #9900ff";
        el.style.zIndex = Z_INDEX.wrl_true;
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á popup WRL
      const popup = new mapboxgl.Popup({offset: 10, closeButton: true}).setHTML(`
        <div style="font-size:13px;font-weight:600;">
          ${p.site ?? "-"}
        </div>
      `);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á marker + ‡∏ú‡∏π‡∏Å popup
      if(!p.site || !p.site.trim()){
        return;
      }
      const key = p.site.trim();

      const marker = new mapboxgl.Marker(el)
	.setLngLat([lng, lat])
        .setPopup(popup);

      // ‚úÖ FIX iPad Pencil popup (WRL)
      el.addEventListener('pointerup', e => {
        e.stopPropagation();

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ popup ‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô
        if(currentPopup){
          currentPopup.remove();
          currentPopup = null;
        }
        popup.addTo(map);
        currentPopup = popup;
      });

      if (wrlVisible) {
        marker.addTo(map);
      }

      wrlMarkers.set(key, marker);

    });

    document.getElementById("btnWRL").style.display = "block";
	
  }catch(e){
    console.error("WRL load error:",e);
  }
}


function syncWRLStatus(newData){

  console.log("‚ö° WRL SYNC >> START");

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Map ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (key = site)
  const statusMap = new Map();

  newData.forEach(p=>{
    if(!p.site || !p.site.trim()){
      return;
    }
    const normalized = String(p.status).toLowerCase() === "true";
    statusMap.set(p.site.trim(), normalized);  
  });

  // ‡∏ß‡∏ô marker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
  let updateCount=0;
  
  wrlMarkers.forEach((marker, key)=>{

    const newStatus = statusMap.get(key);

    if(newStatus === undefined){
      return;
    }

    const el = marker.getElement();
    const oldStatus = el.dataset.status;

    // ‡∏ñ‡πâ‡∏≤ status ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á update
    if(oldStatus === String(newStatus)){
      return;
    }	
	
    el.dataset.status = String(newStatus);
    el.classList.remove("wrl-blink");

    if(newStatus === false){

      //üî¥ false = ‡πÅ‡∏î‡∏á + ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
      el.style.backgroundColor = "rgba(153,0,255,0.45)"
      el.style.border = "2.0px solid #ff0000";
      el.style.zIndex = Z_INDEX.wrl_false;

      el.classList.add("wrl-blink");

    }else{

      // üü£ true = ‡∏°‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≠‡∏ô
      el.style.backgroundColor = "rgba(153,0,255,0.15)";
      el.style.border = "1.5px solid #9900ff";
      el.style.zIndex = Z_INDEX.wrl_true;
    }
	
	console.log(`${updateCount + 1}. üîÅ ${key} : ${oldStatus} ‚ûú ${newStatus}`);	
	updateCount++
	
  });

  console.log("‚úÖ WRL SYNC >> COMPLETE");
}


function toggleWRL(){
  wrlVisible = !wrlVisible;
  const btn = document.getElementById("btnWRL");

  if(wrlVisible){
    // ‡πÅ‡∏™‡∏î‡∏á marker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    wrlMarkers.forEach(m => m.addTo(map));

    //sync ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô‡∏Ç‡∏ì‡∏∞‡πÄ‡∏õ‡∏¥‡∏î WRL
    if(latestWRLData.length){
      syncWRLStatus(latestWRLData);
    }

    btn.innerText = "WRL : ON";
    btn.classList.remove("off");

  }else{
    // ‡∏ã‡πà‡∏≠‡∏ô marker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    wrlMarkers.forEach(m => m.remove());
    btn.innerText = "WRL : OFF";
    btn.classList.add("off");

  }
}

map.on('load',async()=>{
  
  const res = await fetch(API_URL);
  const r = await res.json();

  // ===== SET LATEST UPDATE =====
  if(r.latestUpdateStatus){
    document.getElementById("latestUpdateText").textContent =
      r.latestUpdateStatus;
  }

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ Timestamp ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥ Advanced Delta Refresh
  lastUpdateStamp = r.latestUpdateStatus ?? null; 


  if(!r || !r.success || !Array.isArray(r.data)){
    console.warn("MAIN load failed");
    return;
  }
  
  r.data.forEach(p=>{

    const lat = Number(p.lat);
    const lng = Number(p.lng);
    if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;

	// ----- ‡πÄ‡∏£‡∏¥‡πà‡∏°: ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° -----
    //const status=VALID_STATUS.has(p.status)?p.status:"none";
	// ----- ‡∏à‡∏ö: ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° -----

	// ----- ‡πÄ‡∏£‡∏¥‡πà‡∏°: ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà -----	  
	// normalize VALID_STATUS
	const rawStatus = p.status ?? "";
    const status =
      NORMALIZE_STATUS.find(obj => obj.regex.test(rawStatus))?.key
      || "none";
   	// ----- ‡∏à‡∏ö: ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà -----
	
    const device=VALID_DEVICE.has(p.device)?p.device:"none";
    const ack=VALID_ACK.has(p.acknowledge)?p.acknowledge:"none";

    const cls={Connecting:'connecting',Offline:'offline',"Telemetry Failure":'telemetry',Initializing:'initializing',Online:'online',none:'none'}[status];

    const el=document.createElement('div');
    el.className=`marker ${cls}`;

    const marker=new mapboxgl.Marker(el)
      .setLngLat([lng, lat])
      .setPopup(new mapboxgl.Popup({offset:14}).setHTML(`
        <b>Site:</b> ${p.siteId}<br>
        <b>Opt. ID.:</b> ${p.operationId ?? "-"}<br>
		<b>IP:</b> ${p.ipAddress ?? "-"}<br> 
		<b>XY:</b> ${p.lat}, ${p.lng}<br>  
        <b>Status:</b> ${status}<br>
        <b>Device:</b> ${device}<br>
        <b>Ack:</b> ${ack}<br><br>
        <button onclick="window.open(
          'https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}',
          '_blank'
        )"
        style="padding:6px 10px;border:none;border-radius:4px;background:#1a73e8;color:white;cursor:pointer;">
          üöó Directions
        </button>
      `))
      .addTo(map);

      // -start- ‚òÖ ADD : block popup if not allowed by search / filter (allow popup only when Marker label is visible)
      el.addEventListener('click',e=>{
        const m=markers.find(x=>x.el===el);
        if(!m) return;

        const allowPopup =
          (!searchActive || m._passSearch) &&
          (!filterActive || m._passFilter);

        if(!allowPopup){
          e.stopPropagation();
          e.preventDefault();
        }
      });
      // -end- 

      // ‚úÖ FIX iPad Pencil popup
      el.addEventListener('pointerup', e => {

        const m = markers.find(x => x.el === el);
        if(!m) return;

        const allowPopup =
          (!searchActive || m._passSearch) &&
          (!filterActive || m._passFilter);

        if(!allowPopup){
          e.stopPropagation();
          e.preventDefault();
          return;
        }

        // ----- CONTROLLED POPUP -----
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ popup ‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô
        if(currentPopup){
          currentPopup.remove();
          currentPopup = null;
        }
        // ‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏Ç‡∏≠‡∏á marker ‡∏ô‡∏µ‡πâ
        const popup = m.marker.getPopup();
        popup.addTo(map);
        currentPopup = popup;

      });
	  
    const key = `${p.siteId ?? "nosite"}_${p.ipAddress ?? "noip"}`;

    markers.push({
      key,
      marker,
      el,
      status,
      device,
      acknowledge:ack,
      siteId:p.siteId,
      operationId:p.operationId,
	  ipAddress:p.ipAddress,  
      lat:lat,
      lng:lng,

      // -start- ‚òÖ ADD : search / filter flags (allow popup only when Marker label is visible)
      _passSearch:true,
      _passFilter:true
      // -end-

    });

    bounds.extend([lng, lat]);
  });

  map.fitBounds(bounds,{padding:60});

  activeStatuses.add("Connecting");
  activeAck="No";
  document.querySelector('[data-status="Connecting"]').classList.add('active');
  document.querySelector('[data-ack="No"]').classList.add('active');

  applyFilter();

  await loadWRL();
  
  document.getElementById("btnWRL").addEventListener("click", toggleWRL);


  /* ===== CLICK ‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î popup ===== */
  map.on('click', (e) => {

    const target = e.originalEvent.target;

    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏ö‡∏ô marker ‡∏´‡∏£‡∏∑‡∏≠ popup ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î
    if(
      target.closest('.marker') ||
      target.closest('.wrl-marker') ||
      target.closest('.mapboxgl-popup')
    ) return;

    if(currentPopup){
      currentPopup.remove();
      currentPopup = null;
    }
  });
  
});


/* ===== FILTER ===== */
function byStatus(m){return activeStatuses.size===0||activeStatuses.has(m.status);}
function byDevice(m){return !activeDevice||m.device===activeDevice;}
function byAck(m){return !activeAck||m.acknowledge===activeAck;}

function toggleNoneRows(statusNone,deviceNone,ackNone){
  document.querySelector('[data-status="none"]').style.display=statusNone===0?"none":"";
  document.querySelector('[data-device="none"]').style.display=deviceNone===0?"none":"";
  document.querySelector('[data-ack="none"]').style.display=ackNone===0?"none":"";
}

function updateCounters(){
  const base=searchResultSet ?? markers;

  const sBase=base.filter(m=>byDevice(m)&&byAck(m));
  const sNone=sBase.filter(m=>m.status==="none").length;
  c_total.textContent=sBase.length;
  c_connecting.textContent=sBase.filter(m=>m.status==="Connecting").length;
  c_offline.textContent=sBase.filter(m=>m.status==="Offline").length;
  c_telemetry.textContent=sBase.filter(m=>m.status==="Telemetry Failure").length;
  c_initializing.textContent=sBase.filter(m=>m.status==="Initializing").length;
  c_online.textContent=sBase.filter(m=>m.status==="Online").length;
  c_none.textContent=sNone;

  const dBase=base.filter(m=>byStatus(m)&&byAck(m));
  const dNone=dBase.filter(m=>m.device==="none").length;
  d_all.textContent=dBase.length;
  d_dau.textContent=dBase.filter(m=>m.device==="DAU").length;
  d_router.textContent=dBase.filter(m=>m.device==="ROUTER").length;
  d_none.textContent=dNone;

  const aBase=base.filter(m=>byStatus(m)&&byDevice(m));
  const aNone=aBase.filter(m=>m.acknowledge==="none").length;
  a_all.textContent=aBase.length;
  a_yes.textContent=aBase.filter(m=>m.acknowledge==="Yes").length;
  a_no.textContent=aBase.filter(m=>m.acknowledge==="No").length;
  a_none.textContent=aNone;

  toggleNoneRows(sNone,dNone,aNone);
}

/* ===== SEARCH ===== */
function objectToSearchString(obj){
  return Object.values(obj)
    .filter(v=>v!==null && v!==undefined && typeof v!=="object" && typeof v!=="function")
    .map(v=>String(v).toLowerCase())
    .join(" ");
}

/* ‚òÖ‚òÖ‚òÖ UPDATED SEARCH (Search + Status + Device + Ack) ‚òÖ‚òÖ‚òÖ */
function runSearch(){
  const q=searchInput.value.trim().toLowerCase();
  if(!q) return;

  // -start- ‚òÖ ADD : mark search active (allow popup only when Marker label is visible)
  searchActive=true;
  // -end-

  const searched=markers.filter(m=>objectToSearchString(m).includes(q));
  if(searched.length===0){
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");
    searchActive=false;   //reset state
    return;
  }

  const matched=searched.filter(m=>byStatus(m)&&byDevice(m)&&byAck(m));
  if(matched.length===0){
    alert("‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Search ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Filter ‡∏Ç‡∏≠‡∏á Status / Device / Ack.");
    searchActive=false;   //reset state
    return;
  }

  // üî¥ ‡∏õ‡∏¥‡∏î popup (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)  ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£ search ‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î popup
  if(currentPopup){
    currentPopup.remove();
    currentPopup = null;
  }

  searchResultSet=matched;
  searchIndicator.style.display="";
  searchCount.textContent=matched.length;

  markers.forEach(m=>{
    m.el.classList.add('gray');
    m.el.classList.remove('force-blink');
    m.el.style.zIndex=1;

    // -start- ‚òÖ ADD (allow popup only when Marker label is visible)
    m._passSearch=false;
    // -end-
  });

  const b=new mapboxgl.LngLatBounds();
  matched.forEach(m=>{
    m.el.classList.remove('gray');
    m.el.classList.add('force-blink');
    m.el.style.zIndex=Z_INDEX.selected;
    b.extend([m.lng,m.lat]);

    // -start- ‚òÖ ADD (allow popup only when Marker label is visible)
    m._passSearch=true;
    // -end-
  });

  updateCounters();

  matched.length===1
    ? map.flyTo({center:[matched[0].lng,matched[0].lat],zoom:12})
    : map.fitBounds(b,{padding:80});
}

function clearSearch(){
  searchInput.value="";
  searchResultSet=null;
  searchIndicator.style.display="none";

  // -start- ‚òÖ ADD (allow popup only when Marker label is visible)
  searchActive=false;
  markers.forEach(m=>m._passSearch=true);
  // -end-

  applyFilter();
}

searchBtn.onclick=runSearch;
clearSearchBtn.onclick=clearSearch;
searchInput.addEventListener('keypress',e=>{
  if(e.key==="Enter") runSearch();
});

/* ===== EVENTS ===== */
document.querySelectorAll('[data-status]').forEach(r=>{
  r.onclick=()=>{
    const s=r.dataset.status;
    if(s==="TOTAL"){
      // üî¥ ‡∏õ‡∏¥‡∏î popup ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
      if(currentPopup){
        currentPopup.remove();
        currentPopup = null;
      }

      activeStatuses.clear();
      activeDevice=null;
      activeAck=null;
      document.querySelectorAll('.active').forEach(x=>x.classList.remove('active'));
      clearSearch();

      if(!bounds.isEmpty()) map.fitBounds(bounds,{padding:60});
      return;
    }
    activeStatuses.has(s)?activeStatuses.delete(s):activeStatuses.add(s);
    r.classList.toggle('active');
    applyFilter();
  };
});

document.querySelectorAll('[data-device]').forEach(r=>{
  r.onclick=()=>{
    const d=r.dataset.device;
    activeDevice=(d==="ALL"||activeDevice===d)?null:d;
    document.querySelectorAll('[data-device]').forEach(x=>x.classList.remove('active'));
    if(activeDevice) r.classList.add('active');
    applyFilter();
  };
});

document.querySelectorAll('[data-ack]').forEach(r=>{
  r.onclick=()=>{
    const a=r.dataset.ack;
    activeAck=(a==="ALL"||activeAck===a)?null:a;
    document.querySelectorAll('[data-ack]').forEach(x=>x.classList.remove('active'));
    if(activeAck) r.classList.add('active');
    applyFilter();
  };
});

/* ===== FILTER ===== */
function applyFilter(){

  const base = searchResultSet ?? markers;
  const baseSet = new Set(base);

  // -start- ‚òÖ ADD : filter active state (allow popup only when Marker label is visible)
  filterActive =
    activeStatuses.size>0 ||
    activeDevice!==null ||
    activeAck!==null;
  // -end-

  markers.forEach(m=>{
	const inBase = baseSet.has(m);
    const visible = inBase && byStatus(m) && byDevice(m) && byAck(m);

    // -start- ‚òÖ ADD (allow popup only when Marker label is visible)
    m._passFilter = visible;
    // -end-

    const blink = activeStatuses.size===0
      ? m.status==="Connecting"
      : activeStatuses.has(m.status);

    m.el.classList.toggle('gray', !visible);
    m.el.classList.toggle('force-blink', visible && blink);
    m.el.style.zIndex = visible ? (zBase[m.status] ?? zBase._default) : Z_INDEX.hidden;
  });

  document.querySelectorAll('.dot').forEach(d=>d.classList.remove('force-blink'));
  (activeStatuses.size===0?["Connecting"]:[...activeStatuses]).forEach(s=>{
    const dot=document.querySelector(`[data-status="${s}"] .dot`);
    if(dot) dot.classList.add('force-blink');
  });

  updateCounters();
}


//‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° Marker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥ Advanced Delta Refresh
function addMarkerFromData(p,status,device,ack){

  const lat = Number(p.lat);
  const lng = Number(p.lng); 
  if(!Number.isFinite(lat) || !Number.isFinite(lng))  return;

  //‡πÅ‡∏õ‡∏•‡∏á status ‡πÄ‡∏õ‡πá‡∏ô class
  const cls={
    Connecting:'connecting',
    Offline:'offline',
    "Telemetry Failure":'telemetry',
    Initializing:'initializing',
    Online:'online',
    none:'none'
  }[status];

  //‡∏™‡∏£‡πâ‡∏≤‡∏á DOM element (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)
  const el=document.createElement('div');
  el.className=`marker ${cls}`;

  //‡∏™‡∏£‡πâ‡∏≤‡∏á Marker ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° marker ‡∏•‡∏á map)
  const marker=new mapboxgl.Marker(el)
    .setLngLat([lng, lat])
    .setPopup(new mapboxgl.Popup({offset:14}).setHTML(`
      <b>Site:</b> ${p.siteId}<br>
      <b>Opt. ID.:</b> ${p.operationId ?? "-"}<br>
      <b>IP:</b> ${p.ipAddress ?? "-"}<br>
      <b>XY:</b> ${p.lat}, ${p.lng}<br>
      <b>Status:</b> ${status}<br>
      <b>Device:</b> ${device}<br>
      <b>Ack:</b> ${ack}<br><br>
      <button onclick="window.open(
        'https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}',
        '_blank'
      )"
      style="padding:6px 10px;border:none;border-radius:4px;background:#1a73e8;color:white;cursor:pointer;">
        üöó Directions
      </button>
    `))
    .addTo(map);

  // popup protection ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô load ‡πÅ‡∏£‡∏Å
  el.addEventListener('click',e=>{
    const m=markers.find(x=>x.el===el);
    if(!m) return;

    const allowPopup =
      (!searchActive || m._passSearch) &&
      (!filterActive || m._passFilter);

    if(!allowPopup){
      e.stopPropagation();
      e.preventDefault();
    }
  });

  // ‚úÖ FIX iPad Pencil popup
  el.addEventListener('pointerup', e => {

    const m = markers.find(x => x.el === el);
    if(!m) return;

    const allowPopup =
      (!searchActive || m._passSearch) &&
      (!filterActive || m._passFilter);

    if(!allowPopup){
      e.stopPropagation();
      e.preventDefault();
      return;
    }

    // ----- CONTROLLED POPUP -----
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ popup ‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô
    if(currentPopup){
      currentPopup.remove();
      currentPopup = null;
    }
    // ‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏Ç‡∏≠‡∏á marker ‡∏ô‡∏µ‡πâ
    const popup = m.marker.getPopup();
    popup.addTo(map);
    currentPopup = popup;

  });
  
  const key = `${p.siteId ?? "nosite"}_${p.ipAddress ?? "noip"}`;

  markers.push({
    key,
    marker,
    el,
    status,
    device,
    acknowledge:ack,
    siteId:p.siteId,
    operationId:p.operationId,
    ipAddress:p.ipAddress,
    lat:lat,
    lng:lng,
    _passSearch:true,
    _passFilter:true
  });
}


//===== Advanced Delta Refresh Engine ==== 
async function advancedDeltaRefresh(){

  try{

    const res = await fetch(API_URL);
    const r = await res.json();

    if(!r || !r.success || !Array.isArray(r.data)){
      console.warn("Delta load failed");
      return;
    }

     // ‡πÄ‡∏ä‡πá‡∏Ñ timestamp ‡∏Å‡πà‡∏≠‡∏ô
    if(r.latestUpdateStatus === lastUpdateStamp){
      console.log("No data change");
      return;
    }

    console.log("üîÑ DAU/ROUTER DELTA REFRESH >> START");

     // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏∏‡∏°‡∏•‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
    if(r.latestUpdateStatus){
      document.getElementById("latestUpdateText").textContent =
        r.latestUpdateStatus;
    }
	
     // ‡∏™‡∏£‡πâ‡∏≤‡∏á newDataMap
    const newDataMap = new Map();
	
    r.data.forEach(p => {
	  const key = `${p.siteId ?? "nosite"}_${p.ipAddress ?? "noip"}`;
      newDataMap.set(key, p);
    });
	
     // ‡∏™‡∏£‡πâ‡∏≤‡∏á oldDataMap
    const oldDataMap = new Map();
	
    markers.forEach(m => {
      oldDataMap.set(m.key, m);
    });

    let updateCount=0;

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà / ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
    newDataMap.forEach((p, key) => {

      const old = oldDataMap.get(key);

      const rawStatus=p.status??"";
      const status=
        NORMALIZE_STATUS.find(o=>o.regex.test(rawStatus))?.key
        || "none";

      const device=VALID_DEVICE.has(p.device)?p.device:"none";
      const ack=VALID_ACK.has(p.acknowledge)?p.acknowledge:"none";
	  
      const lat = Number(p.lat);
      const lng = Number(p.lng);
	  
      if(!Number.isFinite(lat) || !Number.isFinite(lng)){
	    console.warn("Invalid lat/lng skipped:", key);
        return;
      }
	  
      // ----- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà -----
      if(!old){
        addMarkerFromData(p,status,device,ack);
        return;
      }
	  
      // ----- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -----
      if(old.lat !== lat || old.lng !== lng){
        old.lat = lat;
        old.lng = lng;
        old.marker.setLngLat([lng, lat]);
      } 
	  
      // ----- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -----
      if(old.status!==status ||
         old.device!==device ||
         old.acknowledge!==ack){
		
		console.log(`${updateCount + 1}. üîÅ ${key} : ${old.status} ‚ûú ${status}`);
				 
        old.status=status;
        old.device=device;
        old.acknowledge=ack;

        const cls={
          Connecting:'connecting',
          Offline:'offline',
          "Telemetry Failure":'telemetry',
          Initializing:'initializing',
          Online:'online',
          none:'none'
        }[status];

		old.el.classList.remove(
          "connecting",
          "offline",
          "telemetry",
          "initializing",
          "online",
          "none"
        );

        old.el.classList.add(cls);
		updateCount++;
      }

    });

    // ‡∏•‡∏ö marker ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
    markers.slice().forEach(m => {
	  	  
      if (!newDataMap.has(m.key)) {	  
        m.marker.remove();
        const i=markers.indexOf(m);
        if(i>-1) markers.splice(i,1);
      }
    });

    applyFilter();

    // ===== REBUILD BOUNDS AFTER DELTA =====
    bounds = new mapboxgl.LngLatBounds();
    markers.forEach(m=>{
      bounds.extend([m.lng, m.lat]);
    });
	
    console.log("‚úÖ DAU/ROUTER DELTA REFRESH >> COMPLETE");
	
	
    //-------------------------------
    //       WRL DELTA REFRESH 
	//-------------------------------
    try{

	  console.log("üîÑ WRL DELTA REFRESH >> START");

      const wrlRes = await fetch(API_WRL + "&t=" + Date.now());
      const wrlJson = await wrlRes.json();

      if(wrlJson.success && Array.isArray(wrlJson.data)){

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÄ‡∏™‡∏°‡∏≠
        latestWRLData = wrlJson.data;

        // ‡∏ñ‡πâ‡∏≤ WRL ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ sync ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if(wrlVisible){
          syncWRLStatus(latestWRLData);
        }
		
      }	  
	  console.log("‚úÖ WRL DELTA REFRESH >> COMPLETE");

    }catch(err){
      console.warn("WRL delta refresh error:", err);
    }

    lastUpdateStamp=r.latestUpdateStatus??null;

  }catch(e){
    console.error("Advanced delta error:",e);
  }
}


//===== ‡∏ó‡∏≥ Advanced Delta Refresh ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ =====
//-------------------------------------------
//‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1 : Refresh ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
//setInterval(advancedDeltaRefresh, 5*60*1000); 
//-------------------------------------------
//‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2 : Default Refresh ‡∏ó‡∏∏‡∏Å ‡πÜ 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ 2 ‡∏ô‡∏≤‡∏ó‡∏µ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
function startAlignedRefresh(intervalMin = 5, baseMinute = 2, baseSecond = 30) {  
  function scheduleNext() {

    const now = new Date();
    const currentMin = now.getMinutes();

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡∏≤‡∏ó‡∏µ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ 2.30 ‡∏´‡∏£‡∏∑‡∏≠ 7.30
    let nextMin = Math.ceil((currentMin - baseMinute) / intervalMin) 
	              * intervalMin + baseMinute;
				  
    let nextTime = new Date(now);

    if (nextMin >= 60) {
      nextTime.setHours(now.getHours() + 1);
      nextTime.setMinutes(baseMinute);
    } else {
      nextTime.setMinutes(nextMin);
    }

    nextTime.setSeconds(baseSecond);
    nextTime.setMilliseconds(0);
	
    // ‡∏Å‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
    if (nextTime <= now) {
      nextTime.setMinutes(nextTime.getMinutes() + intervalMin);
    }	

    const delay = nextTime - new Date();
    console.log("Next refresh at:", nextTime);

    setTimeout(async () => {
      try {
        console.log("üî• Triggered at:", new Date());
        await advancedDeltaRefresh();
      } catch (err) {
        console.error("Refresh error:", err);
      }
      scheduleNext(); 
    }, delay);
  }

  scheduleNext();
}
// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
startAlignedRefresh(5, 2, 30);
//-------------------------------------------

</script>

</div>

</body>
</html>

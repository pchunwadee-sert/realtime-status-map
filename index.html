<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Realtime Status Map</title>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
body{margin:0;}
#map{width:100vw;height:100vh;}

/* ===== MARKER BASE ===== */
.marker{
  border-radius:50%;
  transition:opacity .2s, box-shadow .2s, border .2s;
  box-sizing:border-box;
}

/* ===== FILTERED ===== */
.gray{
  background:#ccc!important;
  opacity:.35;
  animation:none!important;
  box-shadow:none!important;
  border:none!important;
}

/* ===== BLINK ===== */
.force-blink{animation:blink 1s infinite!important;}

/* ===== STATUS COLOR ===== */
.offline{width:8.5px;height:8.5px;background:#FF0000;}
.connecting{width:8.5px;height:8.5px;background:#FF9900;}
.telemetry{width:8.5px;height:8.5px;background:#FFFF00;}
.initializing{width:8.5px;height:8.5px;background:#00FF00;}
.online{width:8.5px;height:8.5px;background:#009900;}
.none{width:8.5px;height:8.5px;background:#F6F6F6;}

/* ===== BLINK BORDER ===== */
.force-blink.offline{border:1.5px solid #990000;box-shadow:0 0 6px rgba(255,0,0,.7);}
.force-blink.connecting{border:1.5px solid #CC7A00;box-shadow:0 0 6px rgba(255,153,0,.7);}
.force-blink.telemetry{border:1.5px solid #B3B300;box-shadow:0 0 6px rgba(255,255,0,.7);}
.force-blink.initializing{border:1.5px solid #009900;box-shadow:0 0 6px rgba(0,255,0,.7);}
.force-blink.online{border:1.5px solid #1B5E20;box-shadow:0 0 6px rgba(46,125,50,.7);}
.force-blink.none{border:1.5px solid #4D4D4D;box-shadow:0 0 6px rgba(0,0,0,.7);}

@keyframes blink{
  0%{opacity:1}
  50%{opacity:.2}
  100%{opacity:1}
}

/* ===== PANEL GROUP (VERTICAL STACK) ===== */
.panel-group{
  position:absolute;
  left:10px;
  top:10px;
  display:flex;
  flex-direction:column;
  gap:30px;
  z-index:999;
}

/* ===== SEARCH GROUP ===== */
.search-group{
  width:auto;
}

/* ===== PANEL WRAP (STATUS / DEVICE / ACK) ===== */
.panel-wrap{
  display:grid;
  grid-template-columns:max-content;
  gap:0px; 
}

/* ===== PANEL BOX ===== */
.panel-box{}
.status-box{margin-bottom:10px;}
.device-box{margin-bottom:10px;}
.ack-box{margin-bottom:0;}

/* ===== PANEL ===== */
.panel{
  background:rgba(255,255,255,.95);
  padding:10px 14px;
  border-radius:8px;
  font-family:sans-serif;
  font-size:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
  min-width:120px;
}

/* ===== ROW ===== */
.row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:6px;
  cursor:pointer;
}
.row:last-child{margin-bottom:0;}
.active{font-weight:bold;}

/* ===== RESET ===== */
.reset{
  color:#1a73e8;
  font-weight:bold;
}

/* ===== DOT ===== */
.dot{
  width:10px;height:10px;border-radius:50%;box-sizing:border-box;
  transition: transform .15s ease, box-shadow .15s ease;
}
.dot.force-blink{
  transform: scale(1.25);
}
.dot-offline{background:#FF0000;border:1px solid #990000;}
.dot-connecting{background:#FF9900;border:1px solid #CC7A00;}
.dot-telemetry{background:#FFFF00;border:1px solid #B3B300;}
.dot-initializing{background:#00FF00;border:1px solid #009900;}
.dot-online{background:#009900;border:1px solid #1B5E20;}
.dot-none{background:#F6F6F6;border:1px solid #4D4D4D;}

.force-blink.dot-offline{border:1.5px solid #990000;box-shadow:0 0 6px rgba(255,0,0,.9);}
.force-blink.dot-connecting{border:1.5px solid #CC7A00;box-shadow:0 0 6px rgba(255,153,0,.9);}
.force-blink.dot-telemetry{border:1.5px solid #B3B300;box-shadow:0 0 6px rgba(255,255,0,.9);}
.force-blink.dot-initializing{border:1.5px solid #009900;box-shadow:0 0 6px rgba(0,255,0,.9);}
.force-blink.dot-online{border:1.5px solid #1B5E20;box-shadow:0 0 6px rgba(46,125,50,.9);}
.force-blink.dot-none{border:1.5px solid #4D4D4D;box-shadow:0 0 6px rgba(0,0,0,.9);}

/* ===== POPUP Z ===== */
.mapboxgl-popup{z-index:15!important;}

/* ===== RESET BUTTON (PRIMARY ACTION) ===== */
.reset-btn{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:4px 8px;
  border-radius:6px;
  background:#1a73e8;
  color:white;
  font-weight:bold;
  cursor:pointer;
  transition:.2s;
}

.reset-btn:hover{
  background:#1558b0;
  box-shadow:0 2px 6px rgba(26,115,232,.4);
}
</style>
</head>

<body>
<div id="map"></div>

<!-- ===== PANEL GROUP (VERTICAL) ===== -->
<div class="panel-group">

  <!-- ===== SEARCH GROUP ===== -->
  <div class="search-group">

    <div class="panel-box">
      <div class="panel" style="display:flex;gap:6px;">
        <input id="searchInput" type="text"
          placeholder="üîç Search anything..."
          style="width:160px;padding:6px;border:1px solid #ccc;border-radius:4px;">
        <button id="searchBtn"
          style="padding:6px 10px;border:none;border-radius:4px;
                 background:#1a73e8;color:white;cursor:pointer;">
          Search
        </button>
      </div>
    </div>

    <div id="searchIndicator" class="panel-box" style="display:none;margin-top:6px;">
      <div class="panel"
        style="background:#e8f0fe;color:#1a73e8;
               display:flex;align-items:center;gap:8px;">
        <span>
          üîç Search Mode :
          <b><span id="searchCount">0</span></b> result(s)
        </span>

        <button id="clearSearchBtn"
          title="Clear Search"
          style="margin-left:auto;
                 padding:2px 8px;
                 border:none;
                 border-radius:6px;
                 background:#1a73e8;
                 color:white;
                 cursor:pointer;">
          ‚úï
        </button>
      </div>
    </div>

  </div>

  <div class="panel-wrap">

    <!-- STATUS -->
    <div class="panel-box status-box">
      <div id="counter" class="panel">
        <div class="row" data-status="TOTAL">
          <span class="reset-btn" title="Clear Status / Device / Ack / Search">
            ‚ü≥ Reset
          </span>
          Total: <span id="c_total">0</span>
        </div>
        <hr>
        <div class="row" data-status="Offline"><span class="dot dot-offline"></span>Offline /Offscan: <span id="c_offline">0</span></div>
        <div class="row" data-status="Connecting"><span class="dot dot-connecting"></span>Connecting: <span id="c_connecting">0</span></div>
        <div class="row" data-status="Telemetry Failure"><span class="dot dot-telemetry"></span>Telemetry: <span id="c_telemetry">0</span></div>
        <div class="row" data-status="Initializing"><span class="dot dot-initializing"></span>Initializing: <span id="c_initializing">0</span></div>
        <div class="row" data-status="Online"><span class="dot dot-online"></span>Online: <span id="c_online">0</span></div>
        <div class="row" data-status="none"><span class="dot dot-none"></span>none: <span id="c_none">0</span></div>
      </div>
    </div>

    <!-- DEVICE -->
    <div class="panel-box device-box">
      <div id="device-filter" class="panel">
        <div class="row" data-device="ALL">Device ALL: <span id="d_all">0</span></div>
        <hr>
        <div class="row" data-device="DAU">DAU: <span id="d_dau">0</span></div>
        <div class="row" data-device="ROUTER">ROUTER: <span id="d_router">0</span></div>
        <div class="row" data-device="none">none: <span id="d_none">0</span></div>
      </div>
    </div>

    <!-- ACK -->
    <div class="panel-box ack-box">
      <div id="ack-filter" class="panel">
        <div class="row" data-ack="ALL">Acknowledge: <span id="a_all">0</span></div>
        <hr>
        <div class="row" data-ack="Yes">Yes: <span id="a_yes">0</span></div>
        <div class="row" data-ack="No">No: <span id="a_no">0</span></div>
        <div class="row" data-ack="none">none: <span id="a_none">0</span></div>
      </div>
    </div>

  </div>
</div>

<script>
mapboxgl.accessToken='pk.eyJ1IjoicHJhc2VydC1tYXBib3giLCJhIjoiY21rczRzanpqMTVrNDNlcHA3cndudHY2NCJ9.tE7h5N64QMt2FczrH06uCA';
//const API_URL='https://script.google.com/macros/s/AKfycbzbsjn2h6Ycy-pANA4TsvPS0u81D034dD3aIgkqNFqnu5nOZXMCik7aVBrZ33wMG21e/exec';

// --- ‡∏•‡πá‡∏≠‡∏Å API ---
const API_KEY="CHANGE_ME_TO_LONG_RANDOM_STRING";
const APP_NAME="REALTIME-MAP";
const API_BASE='https://script.google.com/macros/s/AKfycbzbsjn2h6Ycy-pANA4TsvPS0u81D034dD3aIgkqNFqnu5nOZXMCik7aVBrZ33wMG21e/exec';

const API_URL = `${API_BASE}?key=${encodeURIComponent(API_KEY)}&app=${encodeURIComponent(APP_NAME)}`;
// --------------

const VALID_STATUS=new Set(["Online","Connecting","Initializing","Offline","Telemetry Failure"]);
const VALID_DEVICE=new Set(["DAU","ROUTER"]);
const VALID_ACK=new Set(["Yes","No"]);

const map=new mapboxgl.Map({
  container:'map',
  style:'mapbox://styles/mapbox/streets-v12',
  center:[100.5,17.5],
  zoom:6
});

const markers=[];
const bounds=new mapboxgl.LngLatBounds();
let activeStatuses=new Set(),activeDevice=null,activeAck=null;

// ‚òÖ ADD
let searchResultSet=null;

// -start- ‚òÖ ADD : popup permission state (allow popup only when Marker label is visible)
let searchActive=false;
let filterActive=false;
// -end-

// zIndex priority (higher = more important)
// Search hit: 999
// Connecting > Offline > Failure > Initializing > none > Online
const zBase={Offline:60,Connecting:70,"Telemetry Failure":50,Initializing:40,Online:10,none:30,_default:20};


map.on('load',async()=>{
  const r = await (await fetch(API_URL)).json();
  r.data.forEach(p=>{
    if(!p.lat||!p.lng) return;

    // ===== ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• VALID_STATUS =====
	//
	// ----- ‡πÄ‡∏£‡∏¥‡πà‡∏°: ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° -----
    //const status=VALID_STATUS.has(p.status)?p.status:"none";
	// ----- ‡∏à‡∏ö: ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° -----
	
	// ----- ‡πÄ‡∏£‡∏¥‡πà‡∏°: ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà -----
	// normalize status ‡∏î‡πâ‡∏ß‡∏¢ word boundary (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà
    let rawStatus = p.status ?? "";
    let status =
      [...VALID_STATUS].find(s => 
	    new RegExp(`\\b${s}\\b`, "i").test(rawStatus) 
      ) || "none";
   	// ----- ‡∏à‡∏ö: ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà -----
	
    const device=VALID_DEVICE.has(p.device)?p.device:"none";
    const ack=VALID_ACK.has(p.acknowledge)?p.acknowledge:"none";

    const cls={Connecting:'connecting',Offline:'offline',"Telemetry Failure":'telemetry',Initializing:'initializing',Online:'online',none:'none'}[status];

    const el=document.createElement('div');
    el.className=`marker ${cls}`;

    const marker=new mapboxgl.Marker(el)
      .setLngLat([p.lng,p.lat])
      .setPopup(new mapboxgl.Popup({offset:14}).setHTML(`
        <b>Site:</b> ${p.siteId}<br>
        <b>Opt. ID.:</b> ${p.operationId ?? "-"}<br>
		<b>IP:</b> ${p.ipAddress ?? "-"}<br> 
		<b>XY:</b> ${p.lat}, ${p.lng}<br>  
        <b>Status:</b> ${status}<br>
        <b>Device:</b> ${device}<br>
        <b>Ack:</b> ${ack}<br><br>
        <button onclick="window.open(
          'https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}',
          '_blank'
        )"
        style="padding:6px 10px;border:none;border-radius:4px;background:#1a73e8;color:white;cursor:pointer;">
          üöó Directions
        </button>
      `))
      .addTo(map);

      // -start- ‚òÖ ADD : block popup if not allowed by search / filter (allow popup only when Marker label is visible)
      el.addEventListener('click',e=>{
        const m=markers.find(x=>x.el===el);
        if(!m) return;

        const allowPopup =
          (!searchActive || m._passSearch) &&
          (!filterActive || m._passFilter);

        if(!allowPopup){
          e.stopPropagation();
          e.preventDefault();
        }
      });
      // -end- 

    markers.push({
      marker,
      el,
      status,
      device,
      acknowledge:ack,
      siteId:p.siteId,
      operationId:p.operationId,
	  ipAddress:p.ipAddress,  
      lat:p.lat,
      lng:p.lng,

      // -start- ‚òÖ ADD : search / filter flags (allow popup only when Marker label is visible)
      _passSearch:true,
      _passFilter:true
      // -end-

    });

    bounds.extend([p.lng,p.lat]);
  });

  map.fitBounds(bounds,{padding:60});

  activeStatuses.add("Connecting");
  activeAck="No";
  document.querySelector('[data-status="Connecting"]').classList.add('active');
  document.querySelector('[data-ack="No"]').classList.add('active');

  applyFilter();
});

/* ===== FILTER ===== */
function byStatus(m){return activeStatuses.size===0||activeStatuses.has(m.status);}
function byDevice(m){return !activeDevice||m.device===activeDevice;}
function byAck(m){return !activeAck||m.acknowledge===activeAck;}

function toggleNoneRows(statusNone,deviceNone,ackNone){
  document.querySelector('[data-status="none"]').style.display=statusNone===0?"none":"";
  document.querySelector('[data-device="none"]').style.display=deviceNone===0?"none":"";
  document.querySelector('[data-ack="none"]').style.display=ackNone===0?"none":"";
}

function updateCounters(){
  const base=searchResultSet ?? markers;

  const sBase=base.filter(m=>byDevice(m)&&byAck(m));
  const sNone=sBase.filter(m=>m.status==="none").length;
  c_total.textContent=sBase.length;
  c_connecting.textContent=sBase.filter(m=>m.status==="Connecting").length;
  c_offline.textContent=sBase.filter(m=>m.status==="Offline").length;
  c_telemetry.textContent=sBase.filter(m=>m.status==="Telemetry Failure").length;
  c_initializing.textContent=sBase.filter(m=>m.status==="Initializing").length;
  c_online.textContent=sBase.filter(m=>m.status==="Online").length;
  c_none.textContent=sNone;

  const dBase=base.filter(m=>byStatus(m)&&byAck(m));
  const dNone=dBase.filter(m=>m.device==="none").length;
  d_all.textContent=dBase.length;
  d_dau.textContent=dBase.filter(m=>m.device==="DAU").length;
  d_router.textContent=dBase.filter(m=>m.device==="ROUTER").length;
  d_none.textContent=dNone;

  const aBase=base.filter(m=>byStatus(m)&&byDevice(m));
  const aNone=aBase.filter(m=>m.acknowledge==="none").length;
  a_all.textContent=aBase.length;
  a_yes.textContent=aBase.filter(m=>m.acknowledge==="Yes").length;
  a_no.textContent=aBase.filter(m=>m.acknowledge==="No").length;
  a_none.textContent=aNone;

  toggleNoneRows(sNone,dNone,aNone);
}

/* ===== SEARCH ===== */
function objectToSearchString(obj){
  return Object.values(obj)
    .filter(v=>v!==null && v!==undefined && typeof v!=="object" && typeof v!=="function")
    .map(v=>String(v).toLowerCase())
    .join(" ");
}

/* ‚òÖ‚òÖ‚òÖ UPDATED SEARCH (Search + Status + Device + Ack) ‚òÖ‚òÖ‚òÖ */
function runSearch(){
  const q=searchInput.value.trim().toLowerCase();
  if(!q) return;

  // -start- ‚òÖ ADD : mark search active (allow popup only when Marker label is visible)
  searchActive=true;
  // -end-

  const searched=markers.filter(m=>objectToSearchString(m).includes(q));
  if(searched.length===0){
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");
    return;
  }

  const matched=searched.filter(m=>byStatus(m)&&byDevice(m)&&byAck(m));
  if(matched.length===0){
    alert("‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Search ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Status / Device / Ack");
    return;
  }

  searchResultSet=matched;
  searchIndicator.style.display="";
  searchCount.textContent=matched.length;

  markers.forEach(m=>{
    m.el.classList.add('gray');
    m.el.classList.remove('force-blink');
    m.el.style.zIndex=1;

    // -start- ‚òÖ ADD (allow popup only when Marker label is visible)
    m._passSearch=false;
    // -end-
  });

  const b=new mapboxgl.LngLatBounds();
  matched.forEach(m=>{
    m.el.classList.remove('gray');
    m.el.classList.add('force-blink');
    m.el.style.zIndex=999;
    b.extend([m.lng,m.lat]);

    // -start- ‚òÖ ADD (allow popup only when Marker label is visible)
    m._passSearch=true;
    // -end-
  });

  updateCounters();

  matched.length===1
    ? map.flyTo({center:[matched[0].lng,matched[0].lat],zoom:12})
    : map.fitBounds(b,{padding:80});
}

function clearSearch(){
  searchInput.value="";
  searchResultSet=null;
  searchIndicator.style.display="none";

  // -start- ‚òÖ ADD (allow popup only when Marker label is visible)
  searchActive=false;
  markers.forEach(m=>m._passSearch=true);
  // -end-

  applyFilter();
}

searchBtn.onclick=runSearch;
clearSearchBtn.onclick=clearSearch;
searchInput.addEventListener('keypress',e=>{
  if(e.key==="Enter") runSearch();
});

/* ===== EVENTS ===== */
document.querySelectorAll('[data-status]').forEach(r=>{
  r.onclick=()=>{
    const s=r.dataset.status;
    if(s==="TOTAL"){
      activeStatuses.clear();
      activeDevice=null;
      activeAck=null;
      document.querySelectorAll('.active').forEach(x=>x.classList.remove('active'));
      clearSearch();
      if(!bounds.isEmpty()) map.fitBounds(bounds,{padding:60});
      return;
    }
    activeStatuses.has(s)?activeStatuses.delete(s):activeStatuses.add(s);
    r.classList.toggle('active');
    applyFilter();
  };
});

document.querySelectorAll('[data-device]').forEach(r=>{
  r.onclick=()=>{
    const d=r.dataset.device;
    activeDevice=(d==="ALL"||activeDevice===d)?null:d;
    document.querySelectorAll('[data-device]').forEach(x=>x.classList.remove('active'));
    if(activeDevice) r.classList.add('active');
    applyFilter();
  };
});

document.querySelectorAll('[data-ack]').forEach(r=>{
  r.onclick=()=>{
    const a=r.dataset.ack;
    activeAck=(a==="ALL"||activeAck===a)?null:a;
    document.querySelectorAll('[data-ack]').forEach(x=>x.classList.remove('active'));
    if(activeAck) r.classList.add('active');
    applyFilter();
  };
});

/* ===== FILTER ===== */
function applyFilter(){

  const base = searchResultSet ?? markers;

  // -start- ‚òÖ ADD : filter active state (allow popup only when Marker label is visible)
  filterActive =
    activeStatuses.size>0 ||
    activeDevice!==null ||
    activeAck!==null;
  // -end-

  markers.forEach(m=>{
    const inBase = base.includes(m);
    const visible = inBase && byStatus(m) && byDevice(m) && byAck(m);

    // -start- ‚òÖ ADD (allow popup only when Marker label is visible)
    m._passFilter = visible;
    // -end-

    const blink = activeStatuses.size===0
      ? m.status==="Connecting"
      : activeStatuses.has(m.status);

    m.el.classList.toggle('gray', !visible);
    m.el.classList.toggle('force-blink', visible && blink);
    m.el.style.zIndex = visible ? (zBase[m.status] ?? zBase._default) : 1;
  });

  document.querySelectorAll('.dot').forEach(d=>d.classList.remove('force-blink'));
  (activeStatuses.size===0?["Connecting"]:[...activeStatuses]).forEach(s=>{
    const dot=document.querySelector(`[data-status="${s}"] .dot`);
    if(dot) dot.classList.add('force-blink');
  });

  updateCounters();
}
</script>
</body>
</html>
